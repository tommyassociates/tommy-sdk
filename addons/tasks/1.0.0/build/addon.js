var addon=function(){var n=window.tommy,i=n.api,o={listsLoaded:!1,tasksLoaded:!1,actor:void 0,actorId:void 0,cache:{},initCache:function initCache(){o.cache={lists:[],tasks:[]}},addTask:function addTask(t){IndexController.invalidateLists=!0,o.cache.tasks[t.id]=t,console.log("task added",t)},addTasks:function addTasks(t){if(o.tasksLoaded=!0,t&&t.length)for(var s=0;s<t.length;s+=1)Array.isArray(t[s])?o.addTasks(t[s]):o.addTask(t[s])},getListTasks:function getListTasks(t){var s=o.cache.lists[t],a=[];for(var e in o.cache.tasks){var i=o.cache.tasks[e];if(s.filters&&i.filters){var n=i.filters.map(function(t){return t.name}),r=s.filters.map(function(t){return t.name}),d=!!n.filter(function(t){return-1!==r.indexOf(t)}).length||!n.length&&!r.length;console.log("task matches list tags",i.name,i.filters,s.name,s.filters,d),d&&s.data.statuses&&(d=-1!==s.data.statuses.indexOf(i.status),console.log("task matches list statuses",i.name,i.status,s.name,s.statuses,d)),d&&a.push(i)}}return a},loadListTasks:function loadListTasks(t,s){if(t.data&&t.filters)for(var a=0;a<t.filters.length;a+=1)s.indexOf(t.filters[a].name)<0&&s.push(t.filters[a].name);var e={addon:"tasks",kind:"Task",tags:s,with_filters:!0,with_permission_to:!0,actor_id:o.actorId};return t.data.date_range&&(e.date_range=t.data.date_range),t.data.statuses&&(e.status=t.data.statuses),i.getFragments(e)},loadTasks:function loadTasks(){console.log("load tasks");var t=[];for(var s in o.cache.lists){var a=o.cache.lists[s],e=o.loadListTasks(a);e&&t.push(e)}return Promise.all(t).then(o.addTasks)},addTaskActivity:function addTaskActivity(t,s,a){var e=n.root.user,i={type:s,text:a,time:new Date,user_id:e.id,user_name:e.first_name};return t.data||(t.data={}),t.data.activity||(t.data.activity=[]),t.data.activity.unshift(i),i},saveTask:function saveTask(t){if(t.addon="tasks",t.kind="Task",t.with_filters=!0,t.with_permission_to=!0,t.id||o.addTaskActivity(t,"status",n.i18n.t("task.created_a_task")),t.status||(t.status=o.STATUSES[0]),t.start_at||(t.start_at=(new Date).getTime()),!t.id){t.with_permissions=["task_create_access","task_edit_access"];var s=o.actor;s&&(t.filters||(t.filters=[]),t.filters.push({context:"members",name:s.first_name+" "+s.last_name,user_id:s.user_id}))}var a=Object.assign({},t,{data:JSON.stringify(t.data)});return t.id?i.updateFragment(t.id,a):i.createFragment(a)},addList:function addList(t){o.cache.lists[t.id]=t,console.log("added task list",t)},addLists:function addLists(t){if(o.listsLoaded=!0,t&&t.length)for(var s=0;s<t.length;s+=1)o.addList(t[s])},loadLists:function loadLists(t){return void 0===t&&(t={}),i.getFragments(Object.assign({addon:"tasks",kind:"TaskList",with_filters:!0,with_permission_to:!0,actor_id:o.actorId,user_id:o.actorId},t))},deleteList:function deleteList(t){return IndexController.invalidateLists=!0,delete o.cache.lists[t],console.log("delete list",t),i.deleteFragment(t)},saveList:function saveList(t){t.addon="tasks",t.kind="TaskList",t.with_filters=!0,t.with_permission_to=!0,t.data||(t.data={}),void 0===t.data.position&&(t.data.position=0),void 0===t.data.active&&(t.data.active=!0),void 0===t.data.show_fast_add&&(t.data.show_fast_add=!0),t.id||(t.with_permissions=["task_list_read_access","task_list_edit_access"]);var s=Object.assign({},t,{data:JSON.stringify(t.data),filters:JSON.stringify(t.filters)});return t.id?i.updateFragment(t.id,s):i.createFragment(s)},currentUserTag:function currentUserTag(){return{context:"members",name:window.tommy.config.getCurrentUserName(),user_id:window.tommy.config.getCurrentUserId()}},createDefaultList:function createDefaultList(t){var s={name:n.i18n.t("tasks.index.default-list-name"),data:{default:!0},filters:[{context:"members",name:t.first_name+" "+t.last_name,user_id:t.id}]};return o.saveList(s)},hasDefaultList:function hasDefaultList(){return o.cache.lists&&0<Object.values(o.cache.lists).filter(function(t){return t.data.default}).length},initPermissionSelect:function initPermissionSelect(s,t,a){console.log("init permission selects",t,a);var e={resource_id:a,with_filters:!0};i.getInstalledAddonPermission("tasks",t,e).then(function(t){console.log("installed addon permission",t),t.resource_id=a,window.tommy.tplManager.appendInline("tasks__tagSelectTemplate",t,s.container),o.initTagSelect(s,t)})},initTagSelect:function initTagSelect(t,s){var a=$$(t.container).find('.tag-select[data-permission-name="'+s.name+'"]');console.log("init tag select",s,a.dataset()),window.tommy.tagSelect.initWidget(a,s.filters,function(t){console.log("save permission tags",s,t),i.updateInstalledAddonPermission("tasks",s.name,{resource_id:s.resource_id,with_filters:!0,filters:JSON.stringify(t)})})},STATUSES:["Unassigned","Assigned","Processing","Completed","Closed","Archive Task","Cancel"],translateStatus:function translateStatus(t){if(t)return window.tommy.i18n.t("status."+window.tommy.util.underscore(t),{defaultValue:t})},untranslateStatus:function untranslateStatus(t){for(var s=0;s<o.STATUSES.length;s+=1)if(o.translateStatus(o.STATUSES[s])===t)return o.STATUSES[s]},translatedStatuses:function translatedStatuses(){for(var t=[],s=0;s<o.STATUSES.length;s+=1)t.push(o.translateStatus(o.STATUSES[s]));return t}};return[{path:"/tasks/",component:{render:function(){var a=this,t=a.$createElement,e=a._self._c||t;return e("f7-page",{attrs:{id:"tasks__index",name:"tasks__index"}},[e("f7-navbar",[e("tommy-nav-menu"),a._v(" "),e("f7-nav-title",[a._v(a._s(a.pageTitle))]),a._v(" "),e("f7-nav-right",[e("f7-link",{attrs:{href:"/tasks/board-settings/","icon-f7":"gear"}}),a._v(" "),e("f7-link",{attrs:{href:"/tasks/task-add/","icon-f7":"add"}})],1)],1),a._v(" "),a.orderedLists&&a.orderedLists.length?e("f7-swiper",{attrs:{params:{slidesPerView:"auto",breakpointsInverse:!0,centeredSlides:!1,breakpoints:{768:{centeredSlides:!0}}}}},a._l(a.orderedLists,function(s){return e("f7-swiper-slide",{key:s.id},[e("div",{staticClass:"tasks-list",class:{hasScroll:a.listWithScroll[s.id]},attrs:{"data-id":s.id}},[e("div",{staticClass:"tasks-list-header"},[e("div",[a._v(a._s(s.name))]),a._v(" "),a.canEditList(s)?e("div",[e("a",{attrs:{href:"/tasks/list-edit/"+s.id+"/"}},[e("img",{attrs:{src:a.$addonAssetsUrl+"slice6.png",srcset:a.$addonAssetsUrl+"slice6@2x.png 2x, "+a.$addonAssetsUrl+"slice6@3x.png 3x"}})])]):a._e()]),a._v(" "),e("div",{staticClass:"tasks-list-content"},[s.tasks&&s.tasks.length?a._l(s.tasks,function(t,s){return e("a",{key:s,staticClass:"card task-card",class:a.isTaskDone(t)?"color-gray done":"",attrs:{href:"/tasks/task/"+t.id+"/"}},[e("div",{staticClass:"card-content card-content-padding"},[e("p",[a._v(a._s(t.name))])]),a._v(" "),e("div",{staticClass:"card-footer no-border color-gray"},[t.data.deadline?e("span",{staticClass:"badge",class:a.isPastDate(t.data.deadline)?"bg-red":"bg-blue"},[a._v(a._s(a.humanTime(t.data.deadline)))]):t.data.checklist?e("span",{staticClass:"icon"},[e("img",{attrs:{src:a.$addonAssetsUrl+"slice1.png",srcset:a.$addonAssetsUrl+"slice1@2x.png 2x,"+a.$addonAssetsUrl+"slice1@3x.png 3x"}}),a._v(" "+a._s(a.checklistNumCompleted(t.data.checklist))+" ")]):e("span",{staticClass:"icon"},[e("img",{attrs:{src:a.$addonAssetsUrl+"slice2.png",srcset:a.$addonAssetsUrl+"slice2@2x.png 2x,"+a.$addonAssetsUrl+"slice2@3x.png 3x"}})]),a._v(" "),e("span",[a._v(" "+a._s(t.status?a.taskStatus(t.status):a.$t("tasks.index.unassigned","Unassigned"))+" ")])])])}):a._e()],2),a._v(" "),s.data.show_fast_add?e("div",{staticClass:"tasks-list-footer"},[a.fastAddEnabled[s.id]?e("div",{staticClass:"in"},[e("form",{staticClass:"card-form",on:{submit:function(t){a.fastAddTask(t,s)}}},[e("input",{attrs:{autofocus:"",type:"text"},domProps:{value:a.fastAddValue[s.id]},on:{input:function(t){a.fastAddValue[s.id]=t.target.value}}}),a._v(" "),e("div",{staticClass:"buttons"},[e("a",{staticClass:"button cancel",attrs:{href:"#"},on:{click:function(t){a.$set(a.fastAddEnabled,s.id,!1)}}},[a._v(a._s(a.$t("tasks.index.cancel","Cancel")))]),a._v(" "),e("button",{staticClass:"button button-fill color-red save",attrs:{type:"submit"}},[a._v(a._s(a.$t("tasks.index.done","Done")))])])])]):e("div",{staticClass:"in"},[e("div",{staticClass:"card-add",on:{click:function(t){a.$set(a.fastAddEnabled,s.id,!0)}}},[a._v(a._s(a.$t("tasks.index.add-task","Add task")))])])]):a._e()])])})):a._e()],1)},staticRenderFns:[],data:function data(){return{lists:null,actorId:this.$f7route.query.actor_id,fastAddEnabled:{},fastAddValue:{},listWithScroll:{}}},created:function created(){this.actorId?(o.actorId=parseInt(this.actorId,10),o.actor=this.actor):(delete o.actorId,delete o.actor)},computed:{actor:function actor(){var s=this;return s.actorId?s.$root.teamMembers.filter(function(t){return t.user_id===parseInt(s.actorId,10)})[0]:null},pageTitle:function pageTitle(){var s=this;if(!s.actorId)return s.$t("tasks.index.title","Tasks");var t=s.$root.teamMembers.filter(function(t){return t.user_id===parseInt(s.actorId,10)})[0].first_name;return s.$t("tasks.index.title_user",{user:t})},orderedLists:function orderedLists(){return this.lists?this.lists.sort(function(t,s){return t.data.position-s.data.position}).filter(function(t){return t.data.active}):null}},methods:{humanTime:function humanTime(t){var s=window.tommy.moment,a=s.utc(t).toDate();if(s(a).isValid()){var e=s().diff(s(a),"days");if(1===e)return"Yesterday "+s(a).format("h:mm A");if(0===e)return"Today "+s(a).format("h:mm A");if(-1===e)return"Yesterday "+s(a).format("h:mm A");if(1<=e&&e<=8||-8<=e&&e<=-1)return s(a).format("ddd h:mm A");if(365<=e||e<=-365)return s(a).format("MMM D, YYYY h:mm A");if(8<=e||e<=-8)return s(a).format("MMM D h:mm A")}return"None"},listHasScroll:function listHasScroll(t){if(!t.tasks||0===t.tasks.length)return!1;var s=this.$$('.tasks-list[data-id="'+t.id+'"] .tasks-list-content')[0];return!!s&&s.scrollHeight>s.offsetHeight},loadListTasks:function loadListTasks(s){var a=this,t=a.actor||a.$root.user;o.loadListTasks(s,[t.first_name+" "+t.last_name]).then(function(t){s.tasks=t,a.$nextTick(function(){a.listHasScroll(s)?a.$set(a.listWithScroll,s.id,!0):a.$set(a.listWithScroll,s.id,!1)})})},loadLists:function loadLists(){var s=this;o.loadLists().then(function(t){t.forEach(function(t){t.tasks=[]}),s.lists=t,0<s.lists.filter(function(t){return t.data.default}).length?s.lists.forEach(function(t){s.loadListTasks(t)}):o.createDefaultList(s.$root.user).then(function(){s.loadLists()})})},fastAddTask:function fastAddTask(t,s){var a=this;t.preventDefault();var e=a.fastAddValue[s.id],i={name:e,parent_id:s.id,filters:s.filters};return e&&e.trim()&&(a.fastAddValue[s.id]="",a.fastAddEnabled[s.id]=!1,o.saveTask(i).then(function(t){a.loadListTasks(s)})),!1},isPastDate:function isPastDate(t){return new Date(t)<new Date},checklistNumCompleted:function checklistNumCompleted(t){var s="";t&&t.items&&(s+=t.items.filter(function(t){return t.complete}).length,s+="/",s+=t.items.length);return s},taskStatus:function taskStatus(t){var s=t.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/(^_|_$)/g,"");return this.$t("tasks.status."+s,t)},isTaskDone:function isTaskDone(t){return 0<="Completed,Closed,Archive Task,Cancel".split(",").indexOf(t.data.status)},canEditList:function canEditList(t){var s=this.$root.account,a="Team"===s.type||"TeamMember"===s.type&&0<=s.roles.indexOf("Team Manager");return!(t.data.default&&!a)&&-1!==t.permission_to.indexOf("update")},reloadListsTasks:function reloadListsTasks(){var s=this;s.lists&&s.lists.forEach(function(t){s.loadListTasks(t)})}},beforeDestroy:function beforeDestroy(){this.$events.$off("tasks:reloadListsTasks",this.reloadListsTasks)},mounted:function mounted(){this.loadLists(),this.$events.$on("tasks:reloadListsTasks",this.reloadListsTasks)}}},{path:"/tasks/task/:id/"},{path:"/tasks/list-edit/:id/"},{path:"/tasks/task-add/",component:{render:function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("f7-page",{attrs:{id:"tasks__task-add",name:"tasks__task-add"}},[a("f7-navbar",[a("tommy-nav-back"),s._v(" "),a("f7-nav-title",[s._v(s._s(s.$t("tasks.task-add.title","Add Task")))]),s._v(" "),a("f7-nav-right",[s.name&&s.name.trim().length&&!s.saving?a("f7-link",{attrs:{"icon-f7":"check"},on:{click:s.save}}):s._e()],1)],1),s._v(" "),a("f7-list",[a("f7-list-item",[a("f7-input",{attrs:{type:"text",value:s.name,placeholder:s.$t("tasks.task-add.name","Name")},on:{input:function(t){s.name=t.target.value}}})],1)],1)],1)},staticRenderFns:[],data:function data(){return{name:"",saving:!1}},methods:{save:function save(){var t=this;if(!t.saving){t.saving=!0;var s=t.$root.user,a={name:t.name,filters:[{context:"members",name:s.first_name+" "+s.last_name,user_id:s.id}]};o.saveTask(a).then(function(){t.$events.$emit("tasks:reloadListsTasks"),t.$f7router.back()})}}}}}]}();