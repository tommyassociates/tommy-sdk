!function s(o,r,d){function l(e,t){if(!r[e]){if(!o[e]){var a="function"==typeof require&&require;if(!t&&a)return a(e,!0);if(c)return c(e,!0);var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}var i=r[e]={exports:{}};o[e][0].call(i.exports,function(t){return l(o[e][1][t]||t)},i,i.exports,s,o,r,d)}return r[e].exports}for(var c="function"==typeof require&&require,t=0;t<d.length;t++)l(d[t]);return l}({1:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("./controllers/index"),s=(n=i)&&n.__esModule?n:{default:n};var o={listsLoaded:!1,tasksLoaded:!1,cache:{},initCache:function(){o.cache={lists:{},tasks:{}}},getOrderedLists:function(){if(!o.cache.lists)return[];var t=Object.values(o.cache.lists);return t.length?t.sort(function(t,e){return t.data.position-e.data.position}):[]},addTask:function(t){s.default.invalidateLists=!0,o.cache.tasks[t.id]=t,console.log("task added",t)},addTasks:function(t){if(o.tasksLoaded=!0,t&&t.length)for(var e=0;e<t.length;e++)Array.isArray(t[e])?o.addTasks(t[e]):o.addTask(t[e])},getListTasks:function(t){console.log(o.cache.lists);var n=o.cache.lists[t],i=[];for(var e in o.cache.tasks){var s=o.cache.tasks[e];console.log(n.filters),console.log(s.filters),n.filters&&s.filters&&function(){var t=s.filters.map(function(t){return t.name}),e=n.filters.map(function(t){return t.name}),a=!!t.filter(function(t){return-1!==e.indexOf(t)}).length||!t.length&&!e.length;console.log("task matches list tags",s.name,s.filters,n.name,n.filters,a),a&&n.data.statuses&&(a=-1!==n.data.statuses.indexOf(s.status),console.log("task matches list statuses",s.name,s.status,n.name,n.statuses,a)),a&&i.push(s)}()}return i},loadListTasks:function(t){if(!t._tasksLoaded){t._tasksLoaded=!0;var e=[window.tommy.config.getCurrentUserName()];if(t.data&&t.filters)for(var a=0;a<t.filters.length;a++)e.push(t.filters[a].name);var n={addon:"tasks",kind:"Task",tags:e,include_filters:!0,include_permission_to:!0};return t.data.statuses&&(n.status=t.data.statuses),window.tommy.api.getFragments(n)}console.log("tasks already loaded",t)},loadTasks:function(){console.log("load tasks");var t=[];for(var e in o.cache.lists){var a=o.cache.lists[e],n=o.loadListTasks(a);n&&t.push(n)}return Promise.all(t).then(o.addTasks)},addTaskActivity:function(t,e,a){var n=window.tommy.config.getCurrentUser(),i={type:e,text:a,time:new Date,user_id:n.id,user_name:n.first_name};return t.data||(t.data={}),t.data.activity||(t.data.activity=[]),t.data.activity.unshift(i),i},saveTask:function(t){if(console.log("save task",t),t.name){s.default.invalidateLists=!0,t.addon="tasks",t.kind="Task",t.include_filters=!0,t.include_permission_to=!0,t.id||o.addTaskActivity(t,"status",window.tommy.i18n.t("task.created_a_task")),t.status||(t.status=o.STATUSES[0]),t.start_at||(t.start_at=(new Date).getTime()),t.id||(t.with_permissions=["task_create_access","task_edit_access"]);var e=Object.assign({},t,{data:JSON.stringify(t.data)});return t.id?window.tommy.api.updateFragment(t.id,e).then(o.addTask):window.tommy.api.createFragment(e).then(o.addTask)}alert("Task name must be set")},addList:function(t){o.cache.lists[t.id]=t,console.log("added task list",t)},addLists:function(t){if(o.listsLoaded=!0,t&&t.length)for(var e=0;e<t.length;e++)o.addList(t[e])},loadLists:function(t){return console.log("load task lists",t),t=Object.assign({addon:"tasks",kind:"TaskList",include_filters:!0,include_permission_to:!0},t),window.tommy.api.getFragments(t).then(o.addLists)},deleteList:function(t){return s.default.invalidateLists=!0,delete o.cache.lists[t],console.log("delete list",t),window.tommy.api.deleteFragment(t)},saveList:function(t){console.log("save list",t),o.tasksLoaded=!1,t._tasksLoaded=!1,s.default.invalidateLists=!0,t.addon="tasks",t.kind="TaskList",t.include_filters=!0,t.include_permission_to=!0,t.data||(t.data={}),void 0===t.data.position&&(t.data.position=Object.keys(o.cache.lists).length),void 0===t.data.active&&(t.data.active=!0),void 0===t.data.show_fast_add&&(t.data.show_fast_add=!0),t.id||(t.with_permissions=["task_list_read_access","task_list_edit_access"]);var e=Object.assign({},t,{data:JSON.stringify(t.data),filters:JSON.stringify(t.filters)});return t.id?window.tommy.api.updateFragment(t.id,e).then(o.addList):window.tommy.api.createFragment(e).then(o.addList)},currentUserTag:function(){return{context:"members",name:window.tommy.config.getCurrentUserName(),user_id:window.tommy.config.getCurrentUserId()}},createDefaultList:function(){console.log("creating deafult task list");var t={name:window.tommy.i18n.t("index.default-task-name"),data:{default:!0},filters:[o.currentUserTag()]};return o.saveList(t)},hasDefaultList:function(){return o.cache.lists&&0<Object.values(o.cache.lists).filter(function(t){return t.data.default}).length},initPermissionSelect:function(e,t,a){console.log("init permission selects",t,a);var n={resource_id:a,include_filters:!0};window.tommy.api.getInstalledAddonPermission("tasks",t,n).then(function(t){console.log("installed addon permission",t),t.resource_id=a,window.tommy.tplManager.appendInline("tasks__tagSelectTemplate",t,e.container),o.initTagSelect(e,t)})},initTagSelect:function(t,e){var a=$$(t.container).find('.tag-select[data-permission-name="'+e.name+'"]');console.log("init tag select",e,a.dataset()),window.tommy.tagSelect.initWidget(a,e.filters,function(t){console.log("save permission tags",e,t),window.tommy.api.updateInstalledAddonPermission("tasks",e.name,{resource_id:e.resource_id,include_filters:!0,filters:JSON.stringify(t)})})},isTablet:function(){return 630<=window.innerWidth},STATUSES:["Unassigned","Assigned","Processing","Completed","Closed","Archive Task","Cancel"],translateStatus:function(t){if(t)return window.tommy.i18n.t("status."+window.tommy.util.underscore(t),{defaultValue:t})},untranslateStatus:function(t){for(var e=0;e<o.STATUSES.length;e++)if(o.translateStatus(o.STATUSES[e])===t)return o.STATUSES[e]},translatedStatuses:function(){for(var t=[],e=0;e<o.STATUSES.length;e++)t.push(o.translateStatus(o.STATUSES[e]));return t}};a.default=o},{"./controllers/index":3}],2:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(t){var e=$$(t.container);$$(t.navbarInnerContainer);window.tommy.tplManager.renderInline("tasks__boardSettingTemplate",null,e),window.tommy.util.isTeamOwnerOrManager()&&(s.default.initPermissionSelect(t,"task_create_access"),s.default.initPermissionSelect(t,"task_edit_access"))}};a.default=o},{"../api":1}],3:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var o=n(t("../api")),i=n(t("./task"));function n(t){return t&&t.__esModule?t:{default:t}}var r={init:function(t){console.log("initialize tasks addon"),o.default.listsLoaded?o.default.tasksLoaded?r.invalidate(t):r.loadTasks(t):(o.default.initCache(),o.default.loadLists().then(function(){o.default.hasDefaultList()?r.loadTasks(t):o.default.createDefaultList().then(function(){r.loadTasks(t)})})),r.bind(t)},loadTasks:function(t){o.default.loadTasks().then(function(){r.invalidate(t)})},uninit:function(){console.log("uninitialize tasks addon"),o.default.cache={}},bind:function(n){var t=$$(n.container);t.find(".list-content").each(function(){var t=$$(this);t[0].scrollHeight>=t[0].clientHeight&&t.parent().addClass("hasScroll")}),t.on("click",".fast-add-toggle",function(){var t=$$(this),e=t.closest(".in").removeClass("in").siblings().addClass("in");t.data("input-focus")&&e.find("input").focus()}),t.on("submit","form.fast-add-form",function(t){t.preventDefault();var e=o.default.cache.lists[$$(this).parents("[data-list-id]").data("list-id")],a=window.tommy.app.f7.formToJSON(this);a.filters=e.filters,$$(this).find('input[name="name"]').val(""),o.default.saveTask(a).then(function(){r.invalidate(n)})}),$$(document).on("picker:open",function(t){var e=$$(t.target);if(e.hasClass("tag-select-picker")){var a=window.tommy.config.getCurrentUserName();e.find('input[value="'+a+'"]').parent().parent().addClass("offscreen")}}),t.on("click","a.task-card",function(){var a=$$(this).data("href");$$.get(a,function(t){var e=$$('<div class="popup" data-page="tasks__task" id="tasks__tasks"></div>');e.append(t),e.find(".back").removeClass("back"),e.find(".page").addClass("navbar-fixed"),window.tommy.f7.popup(e),i.default.init({container:e.find(".page")[0],navbarInnerContainer:e.find(".navbar-inner")[0],query:$$.parseUrlQuery(a)}),e.on("popup:close",function(){r.invalidate(n)})})})},invalidate:function(t){console.log("invalidating tasks index");var e=$$(t.container);if(r.invalidateLists||!e.find(".card").length){console.log("rendering task lists"),r.invalidateLists=!1,window.tommy.tplManager.renderInline("tasks__listsTemplate",o.default.getOrderedLists(),t.container);window.tommy.app.f7.swiper(".swiper-container",{centeredSlides:!o.default.isTablet(),spaceBetween:0,freeMode:!1,freeModeSticky:!0,slidesPerView:"auto"})}for(var a in o.default.cache.lists){var n=$$(t.container).find('[data-list-id="'+a+'"] .list-content'),i=o.default.getListTasks(a);console.log(i),window.tommy.tplManager.renderTarget("tasks__listTasksTemplate",i,n)}var s=window.tommy.addons.getCurrentActor();s&&window.tommy.app.setPageTitle(window.tommy.i18n.t("index.title_user",{user:s.first_name}))}};a.default=r},{"../api":1,"./task":8}],4:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(t){var a=$$(t.container);$$(t.navbarInnerContainer).find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(a.find("form"));o.saveList(e),t.preventDefault()})},saveList:function(t){var e={};e.name=t.name,e.filters=[s.default.currentUserTag()],s.default.saveList(e).then(o.afterSave)},afterSave:function(t){console.log("list saved",t),window.tommy.app.f7view.router.back()}};a.default=o},{"../api":1}],5:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var i=n(t("../api"));n(t("./index"));function n(t){return t&&t.__esModule?t:{default:t}}var s={init:function(e){var a=i.default.cache.lists[e.query.list_fragment_id],n=$$(e.container),t=$$(e.navbarInnerContainer);console.log("edit list",a),window.tommy.tplManager.renderInline("tasks__listEditTemplate",a,n),s.initListFilters(e,a),i.default.initPermissionSelect(e,"task_list_read_access",a.id),i.default.initPermissionSelect(e,"task_list_edit_access",a.id),t.find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(n.find("form"));s.saveList(a,e),t.preventDefault()}),n.find(".date-range-select").on("click",function(t){s.showDateRangePopup(e,a),t.preventDefault()}),n.find('select[name="statuses"]').on("change",function(t){a.data.statuses=$$(t.target).val(),console.log("update statuses",a.data.statuses)}),n.find(".delete-list").on("click",function(t){i.default.deleteList(a.id),window.tommy.app.f7view.router.back(),t.preventDefault()})},showDateRangePopup:function(t,e){var a=window.tommy.tplManager.render("tasks__dateRangeSelectTemplate",e.data);window.tommy.f7.popup(a)},initListFilters:function(t,e){var a={title:window.tommy.i18n.t("parmissions.filter_tasks.title"),name:"filter_tasks"},n=window.tommy.tplManager.appendInline("tasks__tagSelectTemplate",a,t.container);console.log("init filter select",e.filters),window.tommy.tagSelect.initWidget(n,e.filters,function(t){console.log("save filter tags",t),e.filters=t})},saveList:function(t,e){t.name=e.name,t.data.show_fast_add=!(!e.show_fast_add||!e.show_fast_add.length),i.default.saveList(t).then(s.afterSave)},afterSave:function(t){console.log("list saved",t),window.tommy.app.f7view.router.back()}};a.default=s},{"../api":1,"./index":3}],6:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(a){var n=$$(a.container),t=$$(a.navbarInnerContainer);window.tommy.tplManager.renderInline("tasks__listManagementTemplate",s.default.getOrderedLists(),n),t.find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(n.find("form"));o.save(a,e),t.preventDefault()})},save:function(t,e){var a=$$(t.container),i=!1;a.find(".sortable [data-list-id]").each(function(t){var e=$$(this),a=s.default.cache.lists[e.data("list-id")],n=e.find('input[type="checkbox"]')[0].checked;console.log("save list order",a.name,a.data.position,t,a.data.active,n),a.data.position==t&&a.data.active==n||(a.data.position=t,a.data.active=n,s.default.saveList(a),console.log("updated list",a),i||(i=!0,window.tommy.app.f7view.router.back()))})}};a.default=o},{"../api":1}],7:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),s=(n=i)&&n.__esModule?n:{default:n};var o={init:function(t){var a=$$(t.container),e=$$(t.navbarInnerContainer);window.tommy.tplManager.renderInline("tasks__addTaskTemplate",{},a),e.find("a.save").on("click",function(t){var e=window.tommy.app.f7.formToJSON(a.find("form"));e.filters=[s.default.currentUserTag()],o.saveTask(e),t.preventDefault()})},saveTask:function(t){s.default.saveTask(t).then(o.afterSave)},afterSave:function(t){console.log("task saved",t),window.tommy.app.f7view.router.back()}};a.default=o},{"../api":1}],8:[function(t,e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var n,i=t("../api"),r=(n=i)&&n.__esModule?n:{default:n};var d={init:function(a){var e=r.default.cache.tasks[a.query.task_fragment_id],t=$$(a.container),n=$$(a.navbarInnerContainer);console.log("init task details",e),window.tommy.tplManager.renderInline("tasks__taskDetailsTemplate",e,t.parent()),t.find(".task-menu-popover").on("popover:open",function(){$$(window).trigger("resize")}),t.find(".task-menu-popover a").click(function(t){var e=$$(t.target).data("command");switch(e){case"add-checklist":d.renderChecklist(a);break;case"add-end-time":d.renderDeadline(a);break;default:alert("Unknown command: "+e)}window.tommy.app.f7.closeModal(".task-menu-popover")}),t.find(".page-content").scroll(function(t){100<t.target.scrollTop?n.addClass("with-title"):n.removeClass("with-title")}),d.initStatusPicker(a),e.data.checklist&&e.data.checklist.items&&d.renderChecklist(a),e.end_at&&d.renderDeadline(a);var i=window.tommy.app.f7.messagebar(".messagebar",{maxHeight:200});t.find(".add-comment").click(function(){d.addActivity(a,"comment",i.value()),i.clear()}),d.renderActivity(a);var s=t.find(".tag-select"),o=[];e.filters&&(o=e.filters),console.log("init task participants",o,s.length),window.tommy.tplManager.renderInline("tasks__taskParticipantsTemplate",o,t),window.tommy.tagSelect.initWidget(s,o,function(t){console.log("task participants changed",t),e.filters=t,window.tommy.tplManager.renderInline("tasks__taskParticipantsTemplate",e.filters,a.container),d.enableSave(a,!0)}),t.find("input.edit-task-name").on("click",function(){d.enableEditName(a,!0)}),t.find("textarea.edit-task-description").on("click",function(){d.enableEditDescription(a,!0)}),n.find("a.save").on("click",function(){d.saveTask(a),d.enableSave(a,!1)}),d.invalidate(a)},invalidate:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id];$$(t.navbarInnerContainer).find(".center").text(e.name)},renderActivity:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id],a=$$(t.container),n=[];e.data.activity&&(n=e.data.activity),window.tommy.tplManager.renderInline("tasks__taskActivityTemplate",n,a)},addActivity:function(t,e,a){var n=r.default.cache.tasks[t.query.task_fragment_id];r.default.addTaskActivity(n,e,a),d.renderActivity(t),d.saveTask(t)},renderChecklist:function(a){var n=r.default.cache.tasks[a.query.task_fragment_id],t=$$(a.container),e=[];n.data.checklist&&n.data.checklist.items&&(e=n.data.checklist.items),window.tommy.tplManager.renderInline("tasks__taskChecklistTemplate",e,t);var i=t.find("input.add-checklist-item");i.on("focusout",function(){var t=$$(this).val();t&&t.length&&(n.data.checklist||(n.data.checklist={}),n.data.checklist.items||(n.data.checklist.items=[]),n.data.checklist.items.push({text:t,complete:!1}),d.renderChecklist(a))}),i.on("focusin",function(){d.enableSave(a)}),t.find(".remove-checklist").click(function(){n.data.checklist={},t.find('[data-template="tasks__taskChecklistTemplate"]').html(""),d.saveTask(a)}),t.find(".remove-checklist-item").click(function(){var t=parseInt($$(this).parents("li").data("checklist-item"));console.log("removing checklist item",t),n.data.checklist.items.splice(t,1),d.renderChecklist(a),d.enableSave(a)}),t.find(".checklist-item").click(function(){var t=parseInt($$(this).parents("li").data("checklist-item")),e=$$(this).hasClass("checked");console.log("toggle checklist item",t),e?($$(this).removeClass("checked"),n.data.checklist.items[t].complete=!1):($$(this).addClass("checked"),n.data.checklist.items[t].complete=!0),d.enableSave(a)})},renderDeadline:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id],a=$$(t.container);console.log("render deadline",e.end_at),window.tommy.tplManager.renderInline("tasks__taskDeadlineTemplate",e.end_at,a);var n=a.find("input.edit-task-deadline"),i=window.tommy.util.createDatePicker(n,e.end_at,{onClose:function(){console.log("closing deadline picker",i.currentDate),e.end_at=i.currentDate,d.enableSave(t)},onFormat:function(t){return console.log("format deadline picker",t),window.tommy.util.humanTime(t)}});e.end_at||n.val(""),a.on("click",".remove-deadline",function(){delete e.end_at,a.find('[data-template="tasks__taskDeadlineTemplate"]').html(""),d.saveTask(t)})},initStatusPicker:function(n){var i=r.default.cache.tasks[n.query.task_fragment_id],t="Unassigned"===i.status?window.tommy.i18n.t("task.waiting_for_assignments"):r.default.translateStatus(i.status);return window.tommy.app.f7.picker({input:$$(n.container).find(".task-status-picker"),value:[t],convertToPopover:!1,cols:[{textAlign:"center",values:r.default.translatedStatuses()}],onClose:function(t){var e=t.value[0],a=r.default.untranslateStatus(t.value[0]);a!=i.status&&(i.status=a,d.addActivity(n,"status",window.tommy.i18n.t("task.changed_status_to",{status:e})),d.saveTask(n))}})},saveTask:function(t){var e=r.default.cache.tasks[t.query.task_fragment_id];console.log("saving task fragment",e),r.default.saveTask(e)},enableEditName:function(t,e){var a=r.default.cache.tasks[t.query.task_fragment_id],n=$$(t.container).find("input.edit-task-name");0!=e&&(d.enableSave(t,!0),n.on("focusout",function(){a.name=n.val(),console.log("set task name",a.name)}))},enableEditDescription:function(t,e){var a=r.default.cache.tasks[t.query.task_fragment_id],n=$$(t.container).find("textarea.edit-task-description");0!=e&&(d.enableSave(t,!0),n.on("focusout",function(){a.data.description=n.val(),console.log("set task description",a.data.description),d.enableEditDescription(t,!1)}))},enableSave:function(t,e){var a=$$(t.navbarInnerContainer).find("a.save");0!=e?(a.siblings().hide(),a.css("display","flex")):(a.siblings().css("display","flex"),a.hide())}};a.default=d},{"../api":1}],9:[function(t,e,a){"use strict";var i=u(t("./api")),n=u(t("./controllers/index")),s=u(t("./controllers/task")),o=u(t("./controllers/task-add")),r=u(t("./controllers/list-add")),d=u(t("./controllers/list-edit")),l=u(t("./controllers/list-management")),c=u(t("./controllers/board-settings"));function u(t){return t&&t.__esModule?t:{default:t}}window.tommy.app.f7.onPageInit("tasks__index",n.default.init),window.tommy.app.f7.onPageBack("tasks__index",n.default.uninit),window.tommy.app.f7.onPageAfterAnimation("tasks__index",n.default.invalidate),window.tommy.app.f7.onPageInit("tasks__board-settings",c.default.init),window.tommy.app.f7.onPageInit("tasks__list-add",r.default.init),window.tommy.app.f7.onPageInit("tasks__list-edit",d.default.init),window.tommy.app.f7.onPageInit("tasks__list-management",l.default.init),window.tommy.app.f7.onPageAfterAnimation("tasks__list-management",l.default.init),window.tommy.app.f7.onPageInit("tasks__task-add",o.default.init),window.tommy.app.f7.onPageInit("tasks__task",s.default.init),window.tommy.app.f7.onPageAfterAnimation("tasks__task",s.default.invalidate),window.tommy.app.t7.registerHelper("tasks__checklistNumCompleted",function(t){var e="";t&&t.items&&(e+=t.items.filter(function(t){return t.complete}).length,e+="/",e+=t.items.length);return e}),window.tommy.app.t7.registerHelper("tasks__displayStatus",function(t){return i.default.translateStatus(t)}),window.tommy.app.t7.registerHelper("tasks__displayStatuses",function(t){return t?t.map(function(t){return i.default.translateStatus(t)}).join(", "):""}),window.tommy.app.t7.registerHelper("tasks__statusSelectOptions",function(t){for(var e="",a=0;a<i.default.STATUSES.length;a++){var n=i.default.STATUSES[a];e+='<option value="'+n+'" '+(t&&-1!==t.indexOf(n)?"selected":"")+">"+i.default.translateStatus(n)+"</option>"}return e}),window.tommy.app.t7.registerHelper("tasks__ifCanEditList",function(t,e){var a=window.tommy.config.getCurrentAccount();return t.data.default&&!window.tommy.util.isTeamOwnerOrManager(a)?e.inverse(t,e.data):-1!==t.permission_to.indexOf("update")?e.fn(t,e.data):e.inverse(t,e.data)}),window.tommy.app.t7.registerHelper("tasks__displayDateRange",function(t){return t})},{"./api":1,"./controllers/board-settings":2,"./controllers/index":3,"./controllers/list-add":4,"./controllers/list-edit":5,"./controllers/list-management":6,"./controllers/task":8,"./controllers/task-add":7}]},{},[9]);